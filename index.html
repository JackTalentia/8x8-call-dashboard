<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Call Time</title>
  <link rel="icon" href="https://talentia.group/wp-content/uploads/2022/09/cropped-favicon-192x192.png"/>
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { height:100% }
    body {
      display:flex; flex-direction:column;
      background:radial-gradient(#000d3b,#000021);
      font-family:'Segoe UI',Tahoma,sans-serif;
      color:#fff;
    }
    .title-bar {
      flex:0 0 auto;
      background:#000d3b;
      padding:.5rem 2rem;
      border-bottom:2px solid #f5ed40ff;
    }
    .title-bar h1 {
      font-family:Oxygen-bold,Arial,sans-serif;
      font-size:2vw;
      text-shadow:2px 2px 8px #000;
    }
    .main-content {
      display:flex;
      flex:1 1 auto;
      overflow:hidden;
    }
    table {
      flex:7;
      border-collapse:collapse;
      font-size:1.3rem;
      table-layout:fixed;
      display:flex; flex-direction:column; height:100%;
    }
    thead { flex:0 0 auto }
    thead tr { display:flex; background:#001a70 }
    thead th {
      flex:1;
      padding:0 .5rem;
      color:#f5ed40ff;
      font-weight:700;
      text-transform:uppercase;
      font-size:1.2rem;
      text-align:left;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    thead th:first-child { flex:0 0 3rem }
    tbody {
      flex:1 1 auto;
      display:flex; flex-direction:column;
    }
    tbody tr {
      flex:1;
      display:flex;
      background:#001245;
      border-bottom:1px solid #1a1a1a;
    }
    tbody tr.highlight {
      background:#f5ed40ff;
      color:#000; font-weight:bold;
    }
    tbody td {
      flex:1;
      padding:0 .5rem;
      display:flex; align-items:center;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      height:48px; line-height:48px;
    }
    tbody td:first-child { flex:0 0 3rem }
    .sidebar {
      flex:3; padding:1rem; text-align:center; overflow:hidden;
    }
    .sidebar img {
      border-radius:12px;
      width:180px; height:180px; object-fit:cover;
      margin:1rem 0;
    }
    .sidebar h2 { font-size:1.7rem; color:#f5ed40ff; margin-bottom:.5rem }
    .sidebar .stat { font-size:1.4rem; margin-top:.5rem }
    .sidebar .stat span { display:block; font-size:2.5rem; color:#f5ed40ff }
    .empty-message { text-align:center; margin:2rem; font-size:1.4rem; color:#f5ed40ff }
  </style>
</head>
<body>
  <div class="title-bar"><h1>Call Time</h1></div>
  <div class="main-content">
    <table id="callSummaryTable">
      <thead>
        <tr><th>Rank</th><th>Name</th><th>Dials</th><th>Talk Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="sidebar" id="topPerformerSidebar" style="display:none">
      <h2 id="topName"></h2>
      <img id="topPhoto" src="" alt="">
      <div class="stat">Dials<span id="topDials">0</span></div>
      <div class="stat">Talk Time<span id="topTalkTime">0:00</span></div>
    </div>
  </div>
  <div class="empty-message" id="emptyState" style="display:none">
    No data available for today.
  </div>

  <script>
  const SUMMARY_URL    = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Call-Summaries";
  const JOIN_URL       = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Employee-Join";
  const TREND_URL      = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Call-Trend";
  const KEY            = "https://docs.google.com/drawings/d/e/2PACX-1vT_8sRZLulgLi8vByqho1d1U0dP7d-wvNZ_0TC2zPpfQHk4vPTOZ4HHruVyGxKYAUqEY780Spopi7Cb/pub?w=1440&h=1080";

  const PAGE_SIZE = 10, HIGHLIGHT_MS = 2000, REFRESH_MS = 60000;
  let currentPage = 0, highlightIndex = 0, highlightTimer, refreshTimer;

  function fmtTalkTime(s) {
    const m = Math.floor(s/60);
    return `${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}`;
  }
  function fmtDateTime(d) {
    return d.toISOString().slice(0,19).replace("T"," ");
  }

  function parseFilters() {
    const p = new URLSearchParams(location.search), f = {};
    f.includeAll = (p.get("include")||"").toLowerCase()==="all";
    if (p.has("Sales"))      f.department="Sales";
    if (p.has("Location"))   f.location=p.get("Location");
    if (p.has("Department")) f.department=p.get("Department");
    return f;
  }

  async function fetchCallSummaries(includeAll) {
    const now=new Date(), s=new Date(now), e=new Date(now);
    s.setHours(7,0,0,0); e.setHours(18,0,0,0);
    const res = await fetch(SUMMARY_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${KEY}`
      },
      body:JSON.stringify({
        startTime: fmtDateTime(s),
        endTime:   fmtDateTime(e),
        timeZone:  "Europe/London",
        minTalkTime: includeAll?0:1,
        fields:["FirstName","LastName","External_Outbound_Total","Total_Talk_Time","Email"]
      })
    });
    const json = await res.json();
    if(!Array.isArray(json)) return [];
    return json
      .filter(o=>o.Email)
      .map(o=>({
        name:o.FirstName+" "+o.LastName,
        email:o.Email.toLowerCase(),
        dials:+o.External_Outbound_Total,
        talkTime:Math.round(+o.Total_Talk_Time/1000)
      }))
      .filter(r=> includeAll?true:r.talkTime>0);
  }

  async function fetchEmployeeDetails(emails) {
    const uniq=[...new Set(emails)];
    if(!uniq.length) return [];
    const res = await fetch(JOIN_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${KEY}`
      },
      body:JSON.stringify({ emails:uniq })
    });
    const json = await res.json();
    return Array.isArray(json)?json:[];
  }

  async function fetchTrend() {
    const res = await fetch(TREND_URL,{
      method:"GET",
      headers:{ "Content-Type":"application/json" }
    });
    return res.ok ? await res.json() : { avgDials:0, avgTalkMs:0 };
  }

  function updateSidebar(row, detail) {
    if(!row) return;
    document.getElementById("topPerformerSidebar").style.display="block";
    document.getElementById("topName").textContent=row.name;
    document.getElementById("topDials").textContent=row.dials;
    document.getElementById("topTalkTime").textContent=fmtTalkTime(row.talkTime);
    const img=document.getElementById("topPhoto"), src=detail?.bamboo_photo_url||FALLBACK_PHOTO;
    if(img.src!==src) img.src=src;
  }

  function render(rows, detailMap) {
    clearInterval(highlightTimer);
    const tbody=document.querySelector("#callSummaryTable tbody");
    tbody.innerHTML="";
    const start=currentPage*PAGE_SIZE, slice=rows.slice(start, start+PAGE_SIZE);
    highlightIndex%=slice.length||1;
    slice.forEach((r,i)=>{
      const tr=document.createElement("tr");
      if(i===highlightIndex) tr.classList.add("highlight");
      tr.innerHTML=`<td>${r.rank}</td><td>${r.name}</td><td>${r.dials}</td><td>${fmtTalkTime(r.talkTime)}</td>`;
      tbody.appendChild(tr);
    });
    updateSidebar(slice[highlightIndex], detailMap[slice[highlightIndex]?.email]);
    highlightTimer=setInterval(()=>{
      highlightIndex++;
      if(highlightIndex>=slice.length){
        highlightIndex=0;
        currentPage=(currentPage+1)%Math.ceil(rows.length/PAGE_SIZE);
      }
      render(rows, detailMap);
    },HIGHLIGHT_MS);
  }

  async function init(){
    clearTimeout(refreshTimer);
    const f=parseFilters();
    const [live, trend, detailsArr] = await Promise.all([
      fetchCallSummaries(f.includeAll),
      fetchTrend(),
      fetchEmployeeDetails(await fetchCallSummaries(f.includeAll).then(r=>r.map(x=>x.email)))
    ]);
    const historic = {
      name:"Joe Bloggs",
      email:"__historic__",
      dials:trend.avgDials,
      talkTime:Math.round(trend.avgTalkMs/1000),
      isHistoric:true
    };
    const all = [historic, ...live];
    all.sort((a,b)=>b.talkTime-a.talkTime);
    const ranked = all.map((r,i)=>({
      ...r,
      rank:r.isHistoric?"â€”":i+1
    }));
    const map = Object.fromEntries(detailsArr.map(d=>[d.work_email.toLowerCase(),d]));
    if(!ranked.length) {
      document.getElementById("emptyState").style.display="block";
    } else {
      currentPage=highlightIndex=0;
      render(ranked, map);
    }
    refreshTimer = setTimeout(init, REFRESH_MS);
  }

  init();
  </script>
</body>
</html>
