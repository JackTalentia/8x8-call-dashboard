<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Call Time</title>
  <link rel="icon" href="https://talentia.group/wp-content/uploads/2022/09/cropped-favicon-192x192.png"/>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    html, body { height: 100% }
    body {
      display: flex; flex-direction: column;
      background: radial-gradient(#000d3b, #000021);
      font-family: 'Segoe UI', Tahoma, sans-serif; color: #fff;
    }
    .title-bar {
      flex: 0 0 auto; background: #000d3b;
      padding: .5rem 2rem; border-bottom: 2px solid #f5ed40ff;
    }
    .title-bar h1 {
      font-family: Oxygen-bold, Arial, sans-serif;
      font-size: 2vw; text-shadow: 2px 2px 8px #000; margin: 0;
    }
    .main-content {
      display: flex; padding: 1rem 2rem; flex: 1 1 auto;
    }
    table {
      width: 70%; font-size: 1.3rem; table-layout: fixed;
      border-collapse: collapse;
      display: flex; flex-direction: column; height: 100%;
    }
    thead { flex: 0 0 auto }
    thead tr { display: flex; background: #001a70 }
    thead th {
      flex: 1; padding: 0 .5rem; color: #f5ed40ff;
      font-weight: 700; text-transform: uppercase;
      font-size: 1.2rem; text-align: left;
      overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
    }
    thead th:first-child { flex: 0 0 3rem }

    tbody {
      flex: 1 1 auto; display: flex; flex-direction: column;
    }
    tbody tr {
      flex: 1; display: flex; background: #001245;
      border-bottom: 1px solid #1a1a1a;
      height: 48px; line-height: 48px;
    }
    tbody tr.highlight {
      background: #f5ed40ff; color: #000; font-weight: bold;
    }
    tbody td {
      flex: 1; padding: 0 .5rem; display: flex;
      align-items: center; overflow: hidden;
      white-space: nowrap; text-overflow: ellipsis;
    }
    tbody td:first-child { flex: 0 0 3rem }

    .sidebar {
      width: 30%; padding-left: 2rem; text-align: center;
    }
    .sidebar img {
      border-radius: 12px; width: 180px; height: 180px;
      object-fit: cover; margin: 1rem 0;
    }
    .sidebar h2 {
      font-size: 1.7rem; color: #f5ed40ff; margin-bottom: .5rem;
    }
    .sidebar .stat {
      font-size: 1.4rem; margin-top: .5rem;
    }
    .sidebar .stat span {
      display: block; font-size: 2.5rem; color: #f5ed40ff;
    }

    .empty-message {
      text-align: center; margin: 2rem; font-size: 1.4rem;
      color: #f5ed40ff;
    }
  </style>
</head>
<body>
  <div class="title-bar"><h1>Call Time</h1></div>
  <div class="main-content">
    <table id="callSummaryTable">
      <thead>
        <tr><th>Rank</th><th>Name</th><th>Dials</th><th>Talk Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="sidebar" id="topPerformerSidebar" style="display:none">
      <h2 id="topName"></h2>
      <img id="topPhoto" src="" alt="">
      <div class="stat">Dials<span id="topDials">0</span></div>
      <div class="stat">Talk Time<span id="topTalkTime">0:00</span></div>
    </div>
  </div>
  <div class="empty-message" id="emptyState" style="display:none">
    No data available for today.
  </div>

  <script>
    const SUMMARY_URL       = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Call-Summaries";
    const EMPLOYEE_JOIN_URL = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Employee-Join";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.…"; 
    const FALLBACK_PHOTO    = "https://docs.google.com/drawings/d/e/2PACX-1vT_8sRZL…";

    const PAGE_SIZE    = 10,
          HIGHLIGHT_MS = 2000,
          REFRESH_MS   = 60000;

    let currentPage    = 0,
        highlightIndex = 0,
        highlightTimer,
        refreshTimer;

    function fmtTalkTime(sec) {
      const m = Math.floor(sec/60);
      return `${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}`;
    }
    function fmtDateTime(d) {
      return d.toISOString().slice(0,19).replace("T"," ");
    }

    function getFiltersFromUrl() {
      const p = new URLSearchParams(location.search), f = {};
      f.includeAll   = (p.get("include")||"").toLowerCase() === "all";
      if (p.has("Sales"))      f.department = "Sales";
      if (p.has("Location"))   f.location   = p.get("Location");
      if (p.has("Department")) f.department = p.get("Department");
      return f;
    }

    async function fetchCallSummaries(includeAll) {
      const now   = new Date(),
            start = new Date(now),
            end   = new Date(now);
      start.setHours(7,0,0,0);
      end  .setHours(18,0,0,0);

      const body = {
        startTime:   fmtDateTime(start),
        endTime:     fmtDateTime(end),
        timeZone:    "Europe/London",
        minTalkTime: includeAll ? 0 : 1,
        fields:      ["FirstName","LastName","External_Outbound_Total","Total_Talk_Time","Email"]
      };

      const res  = await fetch(SUMMARY_URL, {
        method: "POST",
        headers: {
          "Content-Type":  "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(body)
      });
      if (res.status === 401) throw new Error("Unauthorized");
      const json = await res.json();
      if (!Array.isArray(json)) return [];

      return json
        .filter(o => o.Email)
        .map(o => ({
          name:     `${o.FirstName||""} ${o.LastName||""}`.trim(),
          email:    o.Email.toLowerCase(),
          dials:    +o.External_Outbound_Total,
          talkTime: Math.round(+o.Total_Talk_Time/1000)
        }))
        .filter(r => includeAll ? true : r.talkTime > 0);
    }

    async function fetchEmployeeDetails(emails) {
      const uniq = [...new Set(emails)];
      if (!uniq.length) return [];
      const res = await fetch(EMPLOYEE_JOIN_URL, {
        method: "POST",
        headers: {
          "Content-Type":  "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ emails: uniq })
      });
      const json = await res.json();
      return Array.isArray(json) ? json : [];
    }

    function updateSidebar(row, detail) {
      if (!row) return;
      document.getElementById("topPerformerSidebar").style.display = "block";
      document.getElementById("topName").textContent    = row.name;
      document.getElementById("topDials").textContent   = row.dials;
      document.getElementById("topTalkTime").textContent= fmtTalkTime(row.talkTime);

      const img = document.getElementById("topPhoto"),
            src = detail?.bamboo_photo_url || FALLBACK_PHOTO;
      if (img.src !== src) img.src = src;
    }

    function render(rows, detailsMap) {
      clearInterval(highlightTimer);
      const tbody = document.querySelector("#callSummaryTable tbody");
      tbody.innerHTML = "";

      const slice = rows.slice(currentPage*PAGE_SIZE, (currentPage+1)*PAGE_SIZE);
      highlightIndex %= slice.length||1;

      slice.forEach((r,i)=>{
        const tr = document.createElement("tr");
        if (i===highlightIndex) tr.classList.add("highlight");
        tr.innerHTML = `<td>${r.rank}</td><td>${r.name}</td><td>${r.dials}</td><td>${fmtTalkTime(r.talkTime)}</td>`;
        tbody.appendChild(tr);
      });

      updateSidebar(slice[highlightIndex], detailsMap[slice[highlightIndex]?.email]);

      highlightTimer = setInterval(()=>{
        highlightIndex++;
        if (highlightIndex>=slice.length) {
          highlightIndex=0;
          currentPage=(currentPage+1)%Math.ceil(rows.length/PAGE_SIZE);
        }
        render(rows, detailsMap);
      }, HIGHLIGHT_MS);
    }

    async function init() {
      clearTimeout(refreshTimer);
      const filters  = getFiltersFromUrl();
      const callRows = await fetchCallSummaries(filters.includeAll);
      const details  = await fetchEmployeeDetails(callRows.map(r=>r.email));
      const map      = Object.fromEntries(details.map(d=>[d.work_email.toLowerCase(), d]));

      const filtered = callRows
        .filter(r => {
          const d = map[r.email]||{};
          if (filters.location && d.location !== filters.location) return false;
          if (filters.department) {
            if (filters.department==="Sales") return /\(.+\)/.test(d.department||"");
            return (d.department||"").toLowerCase().includes(filters.department.toLowerCase());
          }
          return true;
        })
        .sort((a,b)=>b.talkTime-a.talkTime)
        .map((r,i)=>({...r,rank:i+1}));

      if (!filtered.length) {
        document.getElementById("emptyState").style.display="block";
      } else {
        currentPage=highlightIndex=0;
        render(filtered, map);
      }

      refreshTimer = setTimeout(init, REFRESH_MS);
    }

    init();
  </script>
</body>
</html>
