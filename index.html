<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Call Time</title>
  <link rel="icon" href="https://talentia.group/wp-content/uploads/2022/09/cropped-favicon-192x192.png"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* ───────── shared ───────── */
    body {
      margin: 0;
      background: radial-gradient(#000d3b,#000021);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      color: #fff;
    }
    table {
      width: 70%;
      border-collapse: collapse;
      font-size: 1.3rem;
      table-layout: fixed;
    }
    th, td {
      padding: 0 0.4rem;
      text-align: left;
    }
    th {
      background: #001a70;
      color: #f5ed40ff;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 1.2rem;
    }
    /* default fixed row height */
    tr, td {
      height: 40px !important;
      line-height: 40px !important;
    }
    tr {
      background: #001245;
      border-bottom: 1px solid #1a1a1a;
    }
    tr.highlight {
      background: #f5ed40ff;
      color: #000;
      font-weight: bold;
    }
    th:first-child, td:first-child {
      width: 3rem;
    }
    .empty-message {
      text-align: center;
      margin: 1rem;
      font-size: 1.4rem;
      color: #f5ed40ff;
    }

    /* ─ Sales view doubling ─ */
    .sales-view table {
      font-size: 2.6rem !important;
    }
    .sales-view tr, .sales-view td {
      height: 80px !important;
      line-height: 80px !important;
    }

    /* ───────── default dashboard ───────── */
    #defaultFrame .title-bar {
      background: #000d3b;
      padding: 0.4rem 1.5rem;
      display: flex; align-items: center;
      height: 6vh;
      border-bottom: 2px solid #f5ed40ff;
    }
    #defaultFrame .title-bar h1 {
      font-family: Oxygen-bold, Arial, sans-serif;
      font-size: 2vw;
      color: #fff;
      text-shadow: 2px 2px 8px #000;
      margin: 0;
    }
    #defaultFrame .main-content {
      display: flex;
      padding: 0.5rem 1.5rem;
    }
    #defaultFrame .sidebar {
      width: 30%;
      padding-left: 1.5rem;
      text-align: center;
    }
    #defaultFrame .sidebar img {
      border-radius: 12px;
      width: 160px;
      height: 160px;
      object-fit: cover;
      margin: 0.8rem 0;
    }
    #defaultFrame .sidebar h2 {
      font-size: 1.6rem;
      color: #f5ed40ff;
      margin-bottom: 0.4rem;
    }
    #defaultFrame .sidebar .stat {
      font-size: 1.3rem;
      margin-top: 0.4rem;
    }
    #defaultFrame .sidebar .stat span {
      display: block;
      font-size: 2.4rem;
      color: #f5ed40ff;
    }

    /* ───────── analytics (cubeTV) ───────── */
    #bhFrame { display: none; }
    .header-region {
      padding: 0.5rem 1rem;
      background: #000;
    }
    .header-region .cubetv-logo { height: 40px; }
    #cubetv-page-header ul li span {
      font-family: Oxygen-bold, Arial, sans-serif;
      padding: 0 1vw;
      font-size: 2.35vw;
      color: #fff;
    }
    #cubetv-page-header ul li .fa-circle {
      color: #f5ed40ff;
      margin-left: 0.3rem;
    }
    #cubetv-page-content {
      padding: 0.5rem 1rem;
      border-top: 3px solid #f5ed40ff;
      height: calc(100vh - 12vh);
      overflow: hidden;
    }
  </style>
</head>
<body>
  <!-- default dashboard -->
  <div id="defaultFrame">
    <div class="title-bar"><h1>Call Time</h1></div>
    <div class="main-content">
      <table id="callSummaryTable">
        <thead>
          <tr><th>Rank</th><th>Name</th><th>Dials</th><th>Talk Time</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="sidebar" id="topPerformerSidebar" style="display:none">
        <h2 id="topName"></h2>
        <img id="topPhoto" src="" alt="">
        <div class="stat">Dials<span id="topDials">0</span></div>
        <div class="stat">Talk Time<span id="topTalkTime">0:00</span></div>
      </div>
    </div>
    <div class="empty-message" id="emptyState" style="display:none">
      No data available for today.
    </div>
  </div>

  <!-- analytics frame -->
  <div id="bhFrame">
    <div id="content-region">
      <div class="cubetv-app">
        <div class="header-region">
          <img class="cubetv-logo right"
               src="/img/cubetv/bh-analytics-darkmode-horizontal.svg"
               alt="Bullhorn Analytics">
        </div>
        <div class="center-region">
          <div class="cubetv-page">
            <div id="cubetv-page-header">
              <div><ul style="display:inline-block;margin:0;padding:0">
                <li style="display:inline-block">
                  <span>Call Time</span><i class="fa fa-circle"></i>
                </li>
                <li style="display:inline-block">
                  <span>Talentia Group</span>
                </li>
              </ul></div>
            </div>
            <div id="cubetv-page-content">
              <table id="callSummaryTable">
                <thead>
                  <tr><th>Rank</th><th>Name</th><th>Dials</th><th>Talk Time</th></tr>
                </thead>
                <tbody></tbody>
              </table>
              <div class="sidebar" id="topPerformerSidebar" style="display:none">
                <h2 id="topName"></h2>
                <img id="topPhoto" src="" alt="">
                <div class="stat">Dials<span id="topDials">0</span></div>
                <div class="stat">Talk Time<span id="topTalkTime">0:00</span></div>
              </div>
              <div class="empty-message" id="emptyState" style="display:none">
                No data available for today.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ─ constants ─
    const summaryUrl = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Call-Summaries";
    const joinUrl    = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Employee-Join";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBh...
    const FALLBACK_PHOTO    = "https://docs.google.com/drawings/d/e/2PACX-1vT_...
    const HIGHLIGHT_MS = 2000, REFRESH_MS = 60000;

    let pageSize, highlightTimer, refreshTimer;
    let currentPage = 0, highlightIndex = 0;

    function fmtTalk(sec) {
      const m = Math.floor(sec/60);
      return `${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}`;
    }
    function fmtDate(d) {
      return d.toISOString().slice(0,19).replace('T',' ');
    }

    function getFilters() {
      const p = new URLSearchParams(location.search), f = {};
      f.includeAll    = (p.get("include")||"").toLowerCase()==="all";
      f.department    = p.has("Sales") ? "Sales" : p.get("Department") || null;
      f.location      = p.get("Location") || null;
      f.viewAnalytics = (p.get("view")||"").toLowerCase()==="analytics";
      pageSize = f.viewAnalytics ? 10 : 20;
      return f;
    }

    async function fetchSummaries(includeAll) {
      const now = new Date(), s = new Date(now), e = new Date(now);
      s.setHours(7,0,0,0); e.setHours(18,0,0,0);
      const body = {
        startTime:   fmtDate(s),
        endTime:     fmtDate(e),
        timeZone:    "Europe/London",
        minTalkTime: includeAll ? 0 : 1,
        fields:      ["FirstName","LastName","External_Outbound_Total","Total_Talk_Time","Email"]
      };
      const res = await fetch(summaryUrl, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
        },
        body:JSON.stringify(body)
      });
      const json = await res.json();
      if (!Array.isArray(json)) return [];
      return json
        .filter(o=>o.Email)
        .map(o=>({
          name: o.FirstName.trim()+" "+o.LastName.trim(),
          email: o.Email.toLowerCase(),
          dials: +o.External_Outbound_Total,
          talkTime: Math.round(+o.Total_Talk_Time/1000)
        }))
        .filter(r=> includeAll ? true : r.talkTime > 0);
    }

    async function fetchDetails(emails) {
      const uniq = [...new Set(emails)];
      if (!uniq.length) return [];
      const res = await fetch(joinUrl, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
        },
        body:JSON.stringify({emails:uniq})
      });
      const json = await res.json();
      return Array.isArray(json) ? json : [];
    }

    function updateSidebar(rows, map, container) {
      const row    = rows[highlightIndex];
      const detail = map[row.email] || {};
      document.querySelectorAll(`#${container} #topPerformerSidebar`)
              .forEach(el=>el.style.display="block");
      document.querySelectorAll(`#${container} #topName`)
              .forEach(el=>el.textContent=row.name);
      document.querySelectorAll(`#${container} #topDials`)
              .forEach(el=>el.textContent=row.dials);
      document.querySelectorAll(`#${container} #topTalkTime`)
              .forEach(el=>el.textContent=fmtTalk(row.talkTime));
      const src = detail.bamboo_photo_url || FALLBACK_PHOTO;
      document.querySelectorAll(`#${container} #topPhoto`)
              .forEach(img=>{ if(img.src!==src) img.src=src });
    }

    function render(rows, map, container) {
      clearInterval(highlightTimer);
      const tbody = document
        .querySelector(`#${container} table tbody`);
      tbody.innerHTML="";

      const start = currentPage * pageSize;
      const slice = rows.slice(start, start + pageSize);
      highlightIndex %= slice.length || 1;

      slice.forEach((r,i)=>{
        const tr = document.createElement("tr");
        if(i===highlightIndex) tr.classList.add("highlight");
        tr.innerHTML = `
          <td>${r.rank}</td>
          <td>${r.name}</td>
          <td>${r.dials}</td>
          <td>${fmtTalk(r.talkTime)}</td>
        `;
        tbody.appendChild(tr);
      });

      updateSidebar(slice, map, container);

      highlightTimer = setInterval(()=>{
        highlightIndex++;
        if(highlightIndex >= slice.length) {
          highlightIndex = 0;
          currentPage = (currentPage + 1) % Math.ceil(rows.length / pageSize);
        }
        render(rows, map, container);
      }, HIGHLIGHT_MS);
    }

    async function init() {
      clearTimeout(refreshTimer);
      const f = getFilters();

      // toggle frames
      document.getElementById("defaultFrame").style.display = f.viewAnalytics ? "none" : "block";
      document.getElementById("bhFrame").style.display      = f.viewAnalytics ? "block" : "none";

      // sales-view class
      if(f.department==="Sales") document.body.classList.add("sales-view");
      else document.body.classList.remove("sales-view");

      // fetch & join
      const callRows = await fetchSummaries(f.includeAll);
      const details  = await fetchDetails(callRows.map(r=>r.email));
      const map      = Object.fromEntries(details.map(d=>[d.work_email.toLowerCase(),d]));

      // filter & rank
      const filtered = callRows
        .filter(r => {
          const d = map[r.email] || {};
          if(f.location && d.location !== f.location) return false;
          if(f.department) {
            if(f.department==="Sales")
              return /\(.*\)/.test(d.department||"");
            return (d.department||"")
                     .toLowerCase()
                     .includes(f.department.toLowerCase());
          }
          return true;
        })
        .sort((a,b)=>b.talkTime - a.talkTime)
        .map((r,i)=>({...r, rank: i+1}));

      const container = f.viewAnalytics ? "bhFrame" : "defaultFrame";
      if(!filtered.length) {
        document.querySelectorAll(`#${container} .empty-message`)
                .forEach(el=>el.style.display="block");
      } else {
        currentPage = highlightIndex = 0;
        render(filtered, map, container);
      }

      refreshTimer = setTimeout(init, REFRESH_MS);
    }

    init();
  </script>
</body>
</html>
