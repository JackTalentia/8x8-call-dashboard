<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Call Time</title>
  <link rel="icon" href="https://talentia.group/wp-content/uploads/2022/09/cropped-favicon-192x192.png"/>
  <!-- FontAwesome for cubeTV header icon -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* ───────── Shared Styles ───────── */
    body {
      margin: 0;
      background: radial-gradient(#000d3b,#000021);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      color: #fff;
    }
    table {
      width: 70%;
      border-collapse: collapse;
      font-size: 1.3rem;
      table-layout: fixed;
    }
    th, td {
      padding: 0 0.4rem;
      text-align: left;
    }
    th {
      background: #001a70;
      color: #f5ed40ff;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 1.2rem;
    }
    /* default fixed row height */
    tr, td {
      height: 40px !important;
      line-height: 40px !important;
    }
    tr {
      background: #001245;
      border-bottom: 1px solid #1a1a1a;
    }
    tr.highlight {
      background: #f5ed40ff;
      color: #000;
      font-weight: bold;
    }
    th:first-child, td:first-child {
      width: 3rem;
    }
    .empty-message {
      text-align: center;
      margin: 1rem;
      font-size: 1.4rem;
      color: #f5ed40ff;
    }
    /* Sales view doubling */
    .sales-view table {
      font-size: 2.6rem !important;
    }
    .sales-view tr, .sales-view td {
      height: 80px !important;
      line-height: 80px !important;
    }

    /* ───────── Default Dashboard Styles ───────── */
    #defaultFrame .title-bar {
      background: #000d3b;
      padding: 0.4rem 1.5rem;
      display: flex; align-items: center;
      height: 6vh;
      border-bottom: 2px solid #f5ed40ff;
    }
    #defaultFrame .title-bar h1 {
      font-family: Oxygen-bold, Arial, sans-serif;
      font-size: 2vw;
      color: #fff;
      text-shadow: 2px 2px 8px #000;
      margin: 0;
    }
    #defaultFrame .main-content {
      display: flex;
      padding: 0.5rem 1.5rem;
    }
    #defaultFrame .sidebar {
      width: 30%;
      padding-left: 1.5rem;
      text-align: center;
    }
    #defaultFrame .sidebar img {
      border-radius: 12px;
      width: 160px;
      height: 160px;
      object-fit: cover;
      margin: 0.8rem 0;
    }
    #defaultFrame .sidebar h2 {
      font-size: 1.6rem;
      color: #f5ed40ff;
      margin-bottom: 0.4rem;
    }
    #defaultFrame .sidebar .stat {
      font-size: 1.3rem;
      margin-top: 0.4rem;
    }
    #defaultFrame .sidebar .stat span {
      display: block;
      font-size: 2.4rem;
      color: #f5ed40ff;
    }

    /* ───────── Analytics (cubeTV) Styles ───────── */
    /* hide by default; only shown in analytics mode */
    #bhFrame { display: none; }
    .header-region {
      padding: 0.5rem 1rem;
      background: #000;
    }
    .header-region .cubetv-logo { height: 40px; }
    #cubetv-page-header ul li span {
      font-family: Oxygen-bold, Arial, sans-serif;
      padding: 0 1vw;
      font-size: 2.35vw;
      color: #fff;
    }
    #cubetv-page-header ul li .fa-circle {
      color: #f5ed40ff;
      margin-left: 0.3rem;
    }
    #cubetv-page-content {
      padding: 0.5rem 1rem;
      border-top: 3px solid #f5ed40ff;
      height: calc(100vh - 12vh);
      overflow: hidden;
    }
    /* inside slide-region, reuse your table/sidebar CSS */
  </style>
</head>
<body>
  <!-- ───────── Default Dashboard ───────── -->
  <div id="defaultFrame">
    <div class="title-bar"><h1>Call Time</h1></div>
    <div class="main-content">
      <table id="callSummaryTable">
        <thead><tr><th>Rank</th><th>Name</th><th>Dials</th><th>Talk Time</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="sidebar" id="topPerformerSidebar" style="display:none">
        <h2 id="topName"></h2>
        <img id="topPhoto" src="" alt="">
        <div class="stat">Dials<span id="topDials">0</span></div>
        <div class="stat">Talk Time<span id="topTalkTime">0:00</span></div>
      </div>
    </div>
    <div class="empty-message" id="emptyState" style="display:none">
      No data available for today.
    </div>
  </div>

  <!-- ───────── Analytics (Bullhorn cubeTV) Frame ───────── -->
  <div id="bhFrame">
    <div id="content-region">
      <div class="cubetv-app">
        <div class="header-region">
          <img class="cubetv-logo right"
               src="/img/cubetv/bh-analytics-darkmode-horizontal.svg"
               alt="Bullhorn Analytics">
        </div>
        <div class="center-region">
          <div class="cubetv-page">
            <div id="cubetv-page-header">
              <div><ul style="display:inline-block; margin:0; padding:0;">
                <li style="display:inline-block;"><span>Call Time</span><i class="fa fa-circle"></i></li>
                <li style="display:inline-block;"><span>Talentia Group</span></li>
              </ul></div>
            </div>
            <div id="cubetv-page-content">
              <!-- inside here, paste the same table/sidebar as default -->
              <table id="callSummaryTable">
                <thead><tr><th>Rank</th><th>Name</th><th>Dials</th><th>Talk Time</th></tr></thead>
                <tbody></tbody>
              </table>
              <div class="sidebar" id="topPerformerSidebar" style="display:none">
                <h2 id="topName"></h2>
                <img id="topPhoto" src="" alt="">
                <div class="stat">Dials<span id="topDials">0</span></div>
                <div class="stat">Talk Time<span id="topTalkTime">0:00</span></div>
              </div>
              <div class="empty-message" id="emptyState" style="display:none">
                No data available for today.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ───── common constants ─────
    const callSummaryUrl = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Call-Summaries";
    const lookupUrl      = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Employee-Join";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtZnl4YWF1bWhna292d3VvdnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5MDQ5NTYsImV4cCI6MjA1MTQ4MDk1Nn0.mesbr7DPkdt9Xdq0wa2CNUgfZfDScb2KdX6vvzoUi8I";
    const FALLBACK_PHOTO = "https://docs.google.com/drawings/d/e/2PACX-1vT_8sRZLulgLi8vByqho1d1U0dP7d-wvNZ_0TC2zPpfQHk4vPTOZ4HHruVyGxKYAUqEY780Spopi7Cb/pub?w=1440&h=1080";
    const PAGE_SIZE=10, HIGHLIGHT_MS=2000, REFRESH_MS=60000;

    let highlightTimer, refreshTimer;
    let currentPage=0, highlightIndex=0;

    function formatTalkTime(sec) {
      const m=Math.floor(sec/60);
      return `${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}`;
    }
    function formatDateTime(d){
      return d.toISOString().slice(0,19).replace("T"," ");
    }

    function getFiltersFromUrl(){
      const p=new URLSearchParams(location.search), f={};
      f.includeAll   = (p.get("include")||"").toLowerCase()==="all";
      if(p.has("Sales"))      f.department="Sales";
      if(p.has("Location"))   f.location   = p.get("Location");
      if(p.has("Department")) f.department = p.get("Department");
      f.viewAnalytics = (p.get("view")||"").toLowerCase()==="analytics";
      return f;
    }

    async function fetchCallSummaries(includeAll){
      const now=new Date(), s=new Date(now), e=new Date(now);
      s.setHours(7,0,0,0); e.setHours(18,0,0,0);
      const body={
        startTime:formatDateTime(s),
        endTime:formatDateTime(e),
        timeZone:"Europe/London",
        minTalkTime: includeAll?0:1,
        fields:["FirstName","LastName","External_Outbound_Total","Total_Talk_Time","Email"]
      };
      const res=await fetch(callSummaryUrl,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
        },
        body:JSON.stringify(body)
      });
      const json=await res.json();
      if(!Array.isArray(json))return[];
      return json
        .filter(o=>o.Email)
        .map(o=>({
          name:`${o.FirstName||""} ${o.LastName||""}`.trim(),
          email:o.Email.toLowerCase(),
          dials:+o.External_Outbound_Total,
          talkTime:Math.round(+o.Total_Talk_Time/1000)
        }))
        .filter(r=> includeAll?true:r.talkTime>0);
    }

    async function fetchEmployeeDetails(emails){
      const unique=[...new Set(emails)];
      if(!unique.length) return [];
      const res=await fetch(lookupUrl,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
        },
        body:JSON.stringify({emails:unique})
      });
      const json=await res.json();
      return Array.isArray(json)?json:[];
    }

    function updateSidebar(row, detail){
      if(!row) return;
      document.querySelectorAll("#defaultFrame #topPerformerSidebar, #bhFrame #topPerformerSidebar")
              .forEach(cnt=>cnt.style.display="block");
      document.querySelectorAll("#defaultFrame #topName, #bhFrame #topName")
              .forEach(el=>el.textContent=row.name);
      document.querySelectorAll("#defaultFrame #topDials, #bhFrame #topDials")
              .forEach(el=>el.textContent=row.dials);
      document.querySelectorAll("#defaultFrame #topTalkTime, #bhFrame #topTalkTime")
              .forEach(el=>el.textContent=formatTalkTime(row.talkTime));
      const src=detail?.bamboo_photo_url||FALLBACK_PHOTO;
      document.querySelectorAll("#defaultFrame #topPhoto, #bhFrame #topPhoto")
              .forEach(img=>{ if(img.src!==src) img.src=src });
    }

    function render(rows, map, containerId){
      clearInterval(highlightTimer);
      const tbody=document.querySelector(`#${containerId} table tbody`);
      tbody.innerHTML="";
      const start=currentPage*PAGE_SIZE;
      const slice=rows.slice(start,start+PAGE_SIZE);
      highlightIndex%=slice.length||1;
      slice.forEach((r,i)=>{
        const tr=document.createElement("tr");
        if(i===highlightIndex) tr.classList.add("highlight");
        tr.innerHTML=`<td>${r.rank}</td><td>${r.name}</td><td>${r.dials}</td><td>${formatTalkTime(r.talkTime)}</td>`;
        tbody.appendChild(tr);
      });
      updateSidebar(slice[highlightIndex], map[slice[highlightIndex]?.email]);
      highlightTimer=setInterval(()=>{
        highlightIndex++;
        if(highlightIndex>=slice.length){
          highlightIndex=0;
          currentPage=(currentPage+1)%Math.ceil(rows.length/PAGE_SIZE);
        }
        render(rows,map,containerId);
      },HIGHLIGHT_MS);
    }

    async function init(){
      clearTimeout(refreshTimer);
      const f = getFiltersFromUrl();
      // toggle frames
      document.getElementById("defaultFrame").style.display = f.viewAnalytics ? "none" : "block";
      document.getElementById("bhFrame").style.display      = f.viewAnalytics ? "block" : "none";
      // sales view class
      if(f.department==="Sales") document.body.classList.add("sales-view");
      else document.body.classList.remove("sales-view");

      // fetch & join
      const callRows = await fetchCallSummaries(f.includeAll);
      const details  = await fetchEmployeeDetails(callRows.map(r=>r.email));
      const map = Object.fromEntries(details.map(d=>[d.work_email.toLowerCase(),d]));

      // filter
      const filtered = callRows
        .filter(r=>{
          const d=map[r.email]||{};
          if(f.location && d.location!==f.location) return false;
          if(f.department){
            if(f.department==="Sales")
              return /\(.*\)/.test(d.department||"");
            return (d.department||"").toLowerCase().includes(f.department.toLowerCase());
          }
          return true;
        })
        .sort((a,b)=>b.talkTime-a.talkTime)
        .map((r,i)=>({...r,rank:i+1}));

      // render into the active container
      const container = f.viewAnalytics ? "bhFrame" : "defaultFrame";
      if(!filtered.length){
        document.querySelectorAll(`#${container} .empty-message`)
                .forEach(el=> el.style.display="block");
      } else {
        currentPage=highlightIndex=0;
        render(filtered,map,container);
      }

      refreshTimer=setTimeout(init,REFRESH_MS);
    }

    init();
  </script>
</body>
</html>
