<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Call Time</title>
  <link rel="icon" href="https://talentia.group/wp-content/uploads/2022/09/cropped-favicon-192x192.png" />
  <style>
    body{margin:0;background:radial-gradient(#000d3b,#000021);font-family:'Segoe UI',Tahoma,sans-serif;color:#fff;padding:0}
    .title-bar{background:#000d3b;padding:.5rem 2rem;display:flex;align-items:flex-end;height:6vh;border-bottom:2px solid #f5ed40ff}
    .title-bar h1{font-family:Oxygen-bold,Arial,sans-serif;font-size:2vw;color:#fff;text-shadow:2px 2px 8px #000;line-height:1;font-weight:bold;margin:0}
    .main-content{display:flex;padding:2rem}
    table{width:70%;border-collapse:collapse;font-size:1.4rem;table-layout:fixed}
    th,td{padding:0 .8rem;text-align:left}
    th{background:#001a70;color:#f5ed40ff;font-weight:800;text-transform:uppercase;font-size:1.3rem}
    tr{background:#001245;border-bottom:2px solid #1a1a1a}
    tr.highlight{background:#f5ed40ff;color:#000;font-weight:bold}
    /* fixed row height */
    tr, td{height:56px;line-height:56px}
    th:first-child,td:first-child{width:3.2rem}
    .empty-message{text-align:center;margin-top:2rem;font-size:1.5rem;color:#f5ed40ff}
    .sidebar{width:30%;padding-left:2rem;text-align:center}
    .sidebar img{border-radius:12px;width:200px;height:200px;object-fit:cover;margin:1rem 0}
    .sidebar h2{font-size:1.8rem;color:#f5ed40ff;margin-bottom:1rem}
    .sidebar .stat{font-size:1.5rem;margin-top:1rem}
    .sidebar .stat span{display:block;font-size:3rem;color:#f5ed40ff}
  </style>
</head>
<body>
  <div class="title-bar"><h1>Call Time</h1></div>
  <div class="main-content">
    <table id="callSummaryTable">
      <thead>
        <tr><th>Rank</th><th>Name</th><th>Dials</th><th>Talk Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="sidebar" id="topPerformerSidebar" style="display:none">
      <h2 id="topName"></h2>
      <img id="topPhoto" src="" alt="">
      <div class="stat">Dials<span id="topDials">0</span></div>
      <div class="stat">Talk Time<span id="topTalkTime">0:00</span></div>
    </div>
  </div>
  <div class="empty-message" id="emptyState" style="display:none">No data available for today.</div>

  <script>
    const callSummaryUrl = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Call-Summaries";
    const lookupUrl      = "https://umfyxaaumhgkovwuovzl.supabase.co/functions/v1/8x8-Employee-Join";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";
    const FALLBACK_PHOTO = "https://docs.google.com/drawings/d/e/2PACX-1vT_8sRZLulgLi8vByqho1d1U0dP7d-wvNZ_0TC2zPpfQHk4vPTOZ4HHruVyGxKYAUqEY780Spopi7Cb/pub?w=1440&h=1080";
    const PAGE_SIZE = 10, HIGHLIGHT_MS = 2000, REFRESH_MS = 60000;

    let highlightTimer, refreshTimer;
    let currentPage = 0, highlightIndex = 0;

    function formatTalkTime(sec) {
      const m = Math.floor(sec/60);
      return `${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}`;
    }
    function formatDateTime(d) {
      return d.toISOString().slice(0,19).replace("T"," ");
    }

    function getFiltersFromUrl() {
      const p = new URLSearchParams(location.search), f = {};
      f.includeAll = p.get("include") === "all";         // new flag
      if (p.has("Sales"))     f.department = "Sales";
      if (p.has("Location"))  f.location   = p.get("Location");
      if (p.has("Department"))f.department = p.get("Department");
      return f;
    }

    async function fetchCallSummaries(includeAll) {
      const now=new Date(), start=new Date(now), end=new Date(now);
      start.setHours(7,0,0,0); end.setHours(18,0,0,0);

      const body = {
        startTime: formatDateTime(start),
        endTime:   formatDateTime(end),
        timeZone:  "Europe/London",
        minTalkTime: includeAll ? 0 : 1,  // override when include=all
        fields: ["FirstName","LastName","External_Outbound_Total","Total_Talk_Time","Email"]
      };

      const res = await fetch(callSummaryUrl, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(body)
      });
      const json = await res.json();
      if (!Array.isArray(json)) return [];

      return json
        .filter(o => o.Email)  // always drop blank Email
        .map(o => ({
          name: `${o.FirstName||""} ${o.LastName||""}`.trim(),
          email: o.Email.toLowerCase(),
          dials: +o.External_Outbound_Total,
          talkTime: Math.round(+o.Total_Talk_Time/1000)
        }))
        // only drop zero-talkTime if not includeAll
        .filter(r => includeAll ? true : r.talkTime>0);
    }

    async function fetchEmployeeDetails(emails) {
      const unique = [...new Set(emails)];
      if (!unique.length) return [];
      const res = await fetch(lookupUrl, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ emails: unique })
      });
      const json = await res.json();
      return Array.isArray(json) ? json : [];
    }

    function updateSidebar(row, detail) {
      if (!row) return;
      document.getElementById("topPerformerSidebar").style.display="block";
      document.getElementById("topName").textContent = row.name;
      document.getElementById("topDials").textContent = row.dials;
      document.getElementById("topTalkTime").textContent = formatTalkTime(row.talkTime);
      const img = document.getElementById("topPhoto");
      const src = detail?.bamboo_photo_url || FALLBACK_PHOTO;
      if (img.src !== src) img.src = src;
    }

    function render(rows, detailsMap) {
      clearInterval(highlightTimer);
      const tbody = document.querySelector("#callSummaryTable tbody");
      tbody.innerHTML = "";
      const start = currentPage * PAGE_SIZE;
      const slice = rows.slice(start, start + PAGE_SIZE);
      highlightIndex %= slice.length||1;

      slice.forEach((r,i) => {
        const tr = document.createElement("tr");
        if (i === highlightIndex) tr.classList.add("highlight");
        tr.innerHTML = `<td>${r.rank}</td><td>${r.name}</td><td>${r.dials}</td><td>${formatTalkTime(r.talkTime)}</td>`;
        tbody.appendChild(tr);
      });

      updateSidebar(slice[highlightIndex], detailsMap[slice[highlightIndex]?.email]);

      highlightTimer = setInterval(() => {
        highlightIndex++;
        if (highlightIndex >= slice.length) {
          highlightIndex = 0;
          currentPage = (currentPage + 1) % Math.ceil(rows.length / PAGE_SIZE);
        }
        render(rows, detailsMap);
      }, HIGHLIGHT_MS);
    }

    async function init() {
      clearTimeout(refreshTimer);

      const filters = getFiltersFromUrl();
      const callRows = await fetchCallSummaries(filters.includeAll);
      const detailsArr = await fetchEmployeeDetails(callRows.map(r=>r.email));
      const detailsMap = Object.fromEntries(detailsArr.map(d => [d.work_email.toLowerCase(), d]));

      const filtered = callRows
        .filter(r => {
          const d = detailsMap[r.email];
          if (filters.location && d?.location !== filters.location) return false;
          if (filters.department) {
            if (filters.department === "Sales") {
              return /\(.*\)/.test(d?.department||"");
            }
            return d?.department?.includes(filters.department);
          }
          return true;
        })
        .sort((a,b) => b.talkTime - a.talkTime)
        .map((r,i) => ({ ...r, rank: i+1 }));

      if (!filtered.length) {
        document.getElementById("emptyState").style.display="block";
      } else {
        currentPage = highlightIndex = 0;
        render(filtered, detailsMap);
      }

      refreshTimer = setTimeout(init, REFRESH_MS);
    }

    init();
  </script>
</body>
</html>
